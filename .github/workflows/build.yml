name: Build Optimized Go Binary

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo per esecuzione manuale'
        required: false
        default: 'Manuale'

jobs:
  build-windows:
    name: Build per Windows con Fyne
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5' 
        cache: false 

    - name: Verifica file icona
      run: |
        if (Test-Path "icon.ico") {
          Write-Host "✓ File icon.ico trovato"
        } else {
          Write-Host "✗ ATTENZIONE: File icon.ico non trovato!"
        }
      shell: pwsh

    - name: Initialize Go Module e Install Dependencies
      run: |
        if (-not (Test-Path "go.mod")) {
          go mod init github.com/gulp79/ffmpeg-gui-go
          Write-Host "✓ go.mod creato"
        }
        
        # Aggiorna le dipendenze
        go get -u fyne.io/fyne/v2
        go mod tidy
        
        Write-Host "✓ Dipendenze aggiornate"
      shell: pwsh

    - name: Install Fyne Tools (Latest)
      run: |
        # Installa l'ultima versione del tool CLI
        go install fyne.io/tools/cmd/fyne@latest
        Write-Host "✓ Fyne Tools installato"
      shell: pwsh

    - name: Build con Fyne Package
      run: |
        $env:PATH += ";$env:USERPROFILE\go\bin"
        
        # NOTA: Sintassi aggiornata per i nuovi tool Fyne
        # --os, --icon, --name, --app-id, --release
        
        if (Test-Path "icon.ico") {
          Write-Host "Building con icona..."
          fyne package --os windows --icon icon.ico --name FFmpeg-GUI --app-id com.ffmpeg.gui --release
        } else {
          Write-Host "Building senza icona..."
          fyne package --os windows --name FFmpeg-GUI --app-id com.ffmpeg.gui --release
        }
        
        Write-Host "✓ Build completata"
      shell: pwsh

    - name: Rinomina ed esporta eseguibile
      run: |
        if (Test-Path "FFmpeg-GUI.exe") {
          Write-Host "✓ Eseguibile trovato"
        } else {
          throw "Eseguibile non trovato!"
        }
      shell: pwsh

    - name: Upload FFmpeg-GUI-Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FFmpeg-GUI-Windows
        path: FFmpeg-GUI.exe
        if-no-files-found: error

    - name: Upload go.sum Artifact
      uses: actions/upload-artifact@v4
      with:
        name: go-sum-file
        path: go.sum
        if-no-files-found: error
