name: Build Optimized Go Binary

on:
# Rimuove gli eventi push e pull_request.
  #push:
  #  branches: [ "main", "master" ]
  #pull_request:
  #  branches: [ "main", "master" ]  
# Aggiunge l'evento 'workflow_dispatch' per l'esecuzione manuale.
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo per l''esecuzione manuale (es. "Build per release 1.0")'
        required: false
        default: 'Manuale'

jobs:
  build-windows:
    name: Build per Windows con Fyne
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        # Usa la versione di Go più recente specificata
        go-version: '1.25.5' 
        cache: false 

    - name: Verifica file icona
      run: |
        if (Test-Path "icon.ico") {
          Write-Host "✓ File icon.ico trovato"
          Get-Item "icon.ico" | Format-List
        } else {
          Write-Host "✗ ATTENZIONE: File icon.ico non trovato!"
        }
      shell: pwsh

    - name: Initialize Go Module e Install Dependencies
      run: |
        # Inizializza modulo se non esiste (se il go.mod non è nel repo)
        if (-not (Test-Path "go.mod")) {
          go mod init github.com/gulp79/ffmpeg-gui-go
          Write-Host "✓ go.mod creato"
        }
        
        # Aggiorna il modulo fyne/v2 alla versione più recente
        go get -u fyne.io/fyne/v2
        
        # Pulisce e genera go.sum con tutte le dipendenze aggiornate
        go mod tidy
        
        Write-Host "✓ Dipendenze aggiornate e go.sum generato"
      shell: pwsh

    - name: Install Fyne Tools (Official v2 CLI)
      run: |
        # CORREZIONE CHIAVE: Usa il percorso corretto per la CLI Fyne v2
        go install fyne.io/fyne/v2/cmd/fyne@latest
        Write-Host "✓ Fyne Tools v2 installato"
      shell: pwsh

    - name: Build con Fyne Package
      run: |
        # Aggiungi go/bin al PATH per trovare il comando 'fyne' appena installato
        $env:PATH += ";$env:USERPROFILE\go\bin"
        
        # Parametri corretti per fyne tools
        if (Test-Path "icon.ico") {
          Write-Host "Building con icona..."
          fyne package `
            -os windows `
            -icon icon.ico `
            -name FFmpeg-GUI `
            -appID com.ffmpeg.gui `
            -release
        } else {
          Write-Host "Building senza icona..."
          fyne package `
            -os windows `
            -name FFmpeg-GUI `
            -appID com.ffmpeg.gui `
            -release
        }
        
        Write-Host "✓ Build completata"
      shell: pwsh

    - name: Rinomina eseguibile
      run: |
        # Fyne package crea FFmpeg-GUI.exe nella cartella corrente
        if (Test-Path "FFmpeg-GUI.exe") {
          Write-Host "✓ Eseguibile trovato"
          Get-Item "FFmpeg-GUI.exe" | Format-List Name, Length, LastWriteTime
        } else {
          Write-Host "Cerco in subdirectory..."
          Get-ChildItem -Recurse -Filter "*.exe" | Format-Table FullName, Length
          throw "Eseguibile non trovato!"
        }
      shell: pwsh

    - name: Upload FFmpeg-GUI-Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FFmpeg-GUI-Windows
        path: FFmpeg-GUI.exe
        if-no-files-found: error
        
    - name: Upload go.sum Artifact
      uses: actions/upload-artifact@v4
      with:
        name: go-sum-file
        path: go.sum
        if-no-files-found: error
